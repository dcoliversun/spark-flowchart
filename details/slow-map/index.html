<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="../../img/favicon.ico" rel="shortcut icon"/>
<title>Slow Map - Spark Advanced Topics</title>
<link href="../../css/bootstrap.min.css" rel="stylesheet"/>
<link href="../../css/font-awesome.min.css" rel="stylesheet"/>
<link href="../../css/base.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" rel="stylesheet"/>
<script defer="" src="../../js/jquery-1.10.2.min.js"></script>
<script defer="" src="../../js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
<div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
<div class="container">
<a class="navbar-brand" href="../..">Spark Advanced Topics</a>
<!-- Expander button -->
<button class="navbar-toggler" data-target="#navbar-collapse" data-toggle="collapse" type="button">
<span class="navbar-toggler-icon"></span>
</button>
<!-- Expanded navigation -->
<div class="navbar-collapse collapse" id="navbar-collapse">
<!-- Main navigation -->
<ul class="nav navbar-nav">
<li class="navitem">
<a class="nav-link" href="../..">Spark Advanced Topics Working Group Documentation</a>
</li>
<li class="dropdown active">
<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Details <b class="caret"></b></a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../best-pratice-collect/">Bringing too much data back to the driver (collect and friends)</a>
</li>
<li>
<a class="dropdown-item" href="../big-broadcast-join/">Too big broadcast joins</a>
</li>
<li>
<a class="dropdown-item" href="../broadcast-with-disable/">Tables getting broadcasted even when broadcast is disabled</a>
</li>
<li>
<a class="dropdown-item" href="../class-or-method-not-found/">Class or method not found</a>
</li>
<li>
<a class="dropdown-item" href="../container-oom/">Container OOMs</a>
</li>
<li>
<a class="dropdown-item" href="../correlated-column-not-allowed/">spark.sql.AnalysisException: Correlated column is not allowed in predicate</a>
</li>
<li>
<a class="dropdown-item" href="../driver-max-result-size/">Result size larger than spark.driver.maxResultSize error</a>
</li>
<li>
<a class="dropdown-item" href="../error-driver-max-result-size/">Result size larger than spark.driver.maxResultsSize error</a>
</li>
<li>
<a class="dropdown-item" href="../error-driver-out-of-memory/">Error driver out of memory</a>
</li>
<li>
<a class="dropdown-item" href="../error-driver-stack-overflow/">Error driver stack overflow</a>
</li>
<li>
<a class="dropdown-item" href="../error-executor-out-of-disk/">Executor out of disk error</a>
</li>
<li>
<a class="dropdown-item" href="../error-executor-out-of-memory/">Executor ran out of memory</a>
</li>
<li>
<a class="dropdown-item" href="../error-invalid-file/">Missing Files / File Not Found / Reading past RLE/BitPacking stream</a>
</li>
<li>
<a class="dropdown-item" href="../error-job/">Error</a>
</li>
<li>
<a class="dropdown-item" href="../error-memory/">Memory Errors</a>
</li>
<li>
<a class="dropdown-item" href="../error-other/">Other errors</a>
</li>
<li>
<a class="dropdown-item" href="../error-shuffle/">Fetch Failed exceptions</a>
</li>
<li>
<a class="dropdown-item" href="../error-sql-analysis/">spark.sql.AnalysisException</a>
</li>
<li>
<a class="dropdown-item" href="../even_partitioning_still_slow/">Even Partitioning Yet Still Slow</a>
</li>
<li>
<a class="dropdown-item" href="../failed-to-read-non-parquet-file/">Failed to read non-parquet file</a>
</li>
<li>
<a class="dropdown-item" href="../failure-executor-large-record/">Large record problems can show up in a few different ways.</a>
</li>
<li>
<a class="dropdown-item" href="../forced-computations/">Force computations</a>
</li>
<li>
<a class="dropdown-item" href="../key-skew/">Key/Partition Skew</a>
</li>
<li>
<a class="dropdown-item" href="../notenoughexecs/">Notenoughexecs</a>
</li>
<li>
<a class="dropdown-item" href="../partial_aggregates/">Partial v.s. Full Aggregates</a>
</li>
<li>
<a class="dropdown-item" href="../pyudfoom/">PySpark UDF / UDAF OOM</a>
</li>
<li>
<a class="dropdown-item" href="../read-partition-issue/">Partition at read time</a>
</li>
<li>
<a class="dropdown-item" href="../revise-bad_partitioning/">Bad Partitioning</a>
</li>
<li>
<a class="dropdown-item" href="../revise-even_partitioning_still_slow/">Even Partitioning Yet Still Slow</a>
</li>
<li>
<a class="dropdown-item" href="../slow-executor/">Slow executor</a>
</li>
<li>
<a class="dropdown-item" href="../slow-job/">Slow job</a>
</li>
<li>
<a class="dropdown-item active" href="./">Slow Map</a>
</li>
<li>
<a class="dropdown-item" href="../slow-partition_filter_pushdown/">Partition Filters</a>
</li>
<li>
<a class="dropdown-item" href="../slow-reduce/">Slow reduce</a>
</li>
<li>
<a class="dropdown-item" href="../slow-regex-tips/">Regular Expression Tips</a>
</li>
<li>
<a class="dropdown-item" href="../slow-skewed-join/">Skewed Joins</a>
</li>
<li>
<a class="dropdown-item" href="../slow-skewed-write/">Skewed/Slow Write</a>
</li>
<li>
<a class="dropdown-item" href="../slow-stage/">Identify the slow stage</a>
</li>
<li>
<a class="dropdown-item" href="../slow-writes-s3/">Slow writes on S3</a>
</li>
<li>
<a class="dropdown-item" href="../slow-writes-too-many-files/">Slow writes due to Too many small files</a>
</li>
<li>
<a class="dropdown-item" href="../slow-writes/">Slow Writes</a>
</li>
<li>
<a class="dropdown-item" href="../toobigdag/">Too Big DAG (or when iterative algorithms go bump in the night)</a>
</li>
<li>
<a class="dropdown-item" href="../toofew_tasks/">Toofew tasks</a>
</li>
<li>
<a class="dropdown-item" href="../toomany_tasks/">Toomany tasks</a>
</li>
<li>
<a class="dropdown-item" href="../udfslow/">Avoid UDFs for the most part</a>
</li>
</ul>
</li>
<li class="dropdown">
<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Flowchart <b class="caret"></b></a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../../flowchart/">Index</a>
</li>
<li>
<a class="dropdown-item" href="../../flowchart/error/">Error</a>
</li>
<li>
<a class="dropdown-item" href="../../flowchart/shared/">Shared</a>
</li>
<li>
<a class="dropdown-item" href="../../flowchart/slow/">Slow</a>
</li>
</ul>
</li>
</ul>
<ul class="nav navbar-nav ml-auto">
<li class="nav-item">
<a class="nav-link" data-target="#mkdocs_search_modal" data-toggle="modal" href="#">
<i class="fa fa-search"></i> Search
                            </a>
</li>
<li class="nav-item">
<a class="nav-link" href="../slow-job/" rel="prev">
<i class="fa fa-arrow-left"></i> Previous
                                </a>
</li>
<li class="nav-item">
<a class="nav-link" href="../slow-partition_filter_pushdown/" rel="next">
                                    Next <i class="fa fa-arrow-right"></i>
</a>
</li>
</ul>
</div>
</div>
</div>
<div class="container">
<div class="row">
<div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
<div class="navbar-header">
<button class="navbar-toggler collapsed" data-target="#toc-collapse" data-toggle="collapse" title="Table of Contents" type="button">
<span class="fa fa-angle-down"></span>
</button>
</div>
<div class="navbar-collapse collapse card bg-secondary" id="toc-collapse">
<ul class="nav flex-column">
<li class="nav-item" data-level="1"><a class="nav-link" href="#slow-map">Slow Map</a>
<ul class="nav flex-column">
</ul>
</li>
</ul>
</div>
</div></div>
<div class="col-md-9" role="main">
<h1 id="slow-map">Slow Map</h1>
<p>Below is a list of reasons why your map stage might be slow. Note that this is not an exhaustive list but covers most of the scenarios.</p>
<div class="mermaid">flowchart LR

SlowMap[Slow Read / Map]

SlowMap --&gt; SLOWEXEC[Slow executor]
SlowMap --&gt; EVENPART_SLOW[Even partitioning]
SlowMap --&gt; SkewedMapTasks[Skewed Map Tasks and uneven partitioning]

EVENPART_SLOW   --&gt; MissingSourcePredicates[Reading more data than needed]
EVENPART_SLOW   --&gt; TooFewMapTasks[Not enough Read/Map Tasks]
EVENPART_SLOW   --&gt; TooManyMapTasks[Too many Read/Map Tasks]
EVENPART_SLOW   --&gt; SlowTransformations[Slow Transformations]
EVENPART_SLOW   --&gt; UDFSLOWNESS[Slow UDF]

SkewedMapTasks --&gt; RecordSkew[Record Skew]
SkewedMapTasks --&gt; TaskSkew[Task skew]
TaskSkew --&gt; READPARTITIONISSUES[Read partition issues]
MissingSourcePredicates --&gt; FILTERNOTPUSHED[Filter not pushed]

click EVENPART_SLOW "../../details/even_partitioning_still_slow"
click SLOWEXEC "../../details/slow-executor"
click SkewedMapTasks "../../details/slow-map/#skewed-map-tasks-or-uneven-partitioning"
click RecordSkew "../../details/slow-map/#skewed-map-tasks-or-uneven-partitioning"
click TaskSkew "../../details/slow-map/#skewed-map-tasks-or-uneven-partitioning"
click MissingSourcePredicates "../../details/slow-map/#reading-more-data-than-needed"

click UDFSLOWNESS "../../details/udfslow"
click LARGERECORDS "../../details/failure-executor-large-record"

click TooFewMapTasks "../../details/slow-map/#not-enough-readmap-tasks"
click TooManyMapTasks "../../details/slow-map/#too-many-readmap-tasks"
click SlowTransformations "../../details/slow-map/#slow-transformations"

click FILTERNOTPUSHED "../../details/slow-partition_filter_pushdown"
click SLOWEXEC "../../details/slow-executor"
click READPARTITIONISSUES "../../details/read-partition-issue"

</div>
<h3 id="reading-more-data-than-needed">Reading more data than needed</h3>
<p>Iceberg/Parquet provides 3 layers of data pruning/filtering, so it is recommended to make the most of it by utilizing them as upstream in your ETL as possible.</p>
<ul>
<li>Partition Pruning : Applying a filter on a partition column would mean the Spark can prune all the partitions that are not needed (ex: utc_date, utc_hour etc.). Refer to <a href="../slow-partition_filter_pushdown/">this</a> section for some examples.</li>
<li>Column Pruning : Parquet, a columnar format, allows us to read specific columns from a row group without having to read the entire row. By selecting the fields that you only need for your job/sql(instead of "select *"), you can avoid bringing unnecessary data only to drop it in the subsequent stages.</li>
<li>Predicate Push Down: It is also recommended to use filters on non-partition columns as this would allow Spark to exclude specific row groups while reading data from S3. For ex: <code>account_id is not null</code> if you know that you would be dropping the NULL account_ids eventually.</li>
</ul>
<p>See also <a href="" title="../../details/slow-partition_filter_pushdown">filter not pushed down</a>,  aggregation not pushed down(todo: add details), Bad storage partitioning(todo: add details).</p>
<h3 id="not-enough-readmap-tasks">Not enough Read/Map Tasks</h3>
<p>If your map stage is taking longer, and you are sure that you are not reading more data than needed, then you may be reading the data with small no. of tasks. You can increase the no. of map tasks by decreasing target split size. Note that if you are constrained by the resources(map tasks are just waiting for resources and not in RUNNING status), you would have to request more executors for your job by increasing <code>spark.dynamicAllocation.maxExecutors</code></p>
<h3 id="too-many-readmap-tasks">Too many Read/Map Tasks</h3>
<p>If you have large no. of map tasks in your stage, you could run into driver memory related errors as the task metadata could overwhelm the driver. This also could put a stress on shuffle(on map side) as more map tasks would create more shuffle blocks. It is recommended to keep the task count for a stage under 80k.  You can decrease the no. of map tasks by increasing target split size (todo: add detail) for an Iceberg table. (Note: For a non-iceberg table, the property is <code>spark.sql.maxPartitionBytes</code> and it is at the job level and not at the table level)</p>
<h3 id="slow-transformations">Slow Transformations</h3>
<p>Another reason for slow running map tasks could be from many reason, some common ones include:</p>
<ul>
<li>Regex : You have <code>RegEx</code> in your transformation.  Refer to <a href="../slow-regex-tips/">RegEx tips</a> for tuning.</li>
<li>udf: Make sure you are sending only the data that you need in UDF and tune UDF for performance. Refer to <a href="../udfslow/">Slow UDF</a> for more details.</li>
<li>Json: TBD</li>
</ul>
<p>All these transformations may run into skew issues if you have a <a href="">single row/column that is bloated.</a> You could prevent this by checking the payload size before calling the transformation as a single row/column could potentially slow down the entire stage.</p>
<h3 id="skewed-map-tasks-or-uneven-partitioning">Skewed Map Tasks or Uneven partitioning</h3>
<p>The most common (and most difficult to fix) bad partitioning in Spark is that of skewed partitioning. The data is not evenly distributed amongst the partitions.</p>
<ul>
<li>
<p>Uneven partitioning due to Key-skew : The most frequent cause of skewed partitioning is that of <a href="../key-skew">"key-skew."</a> This happens frequently since humans and machines both tend to cluster resulting in skew (e.g. NYC and <code>null</code>).</p>
</li>
<li>
<p>Uneven partitioning due to input layout: We are used to thinking of partitioning after a shuffle, but partitioning problems can occur at read time as well. This often happens when the layout of the data on disk is not well suited to our computation. In cases where the RDD or Dataframe doesn't have a particular partitioner, data is partitioned according to the storage on disk. Uneven input partitioned data can be fixed with an explicit repartition/shuffle. Spark is often able to avoid input layout issues by combinding and splitting inputs (when input formats are "splittable"), but not all input formats give Spark this freedom. One common example is <code>gzip</code>, although there is a work-around for <a href="https://github.com/nielsbasjes/splittablegzip">"splittable gzip"</a> but this comes at the cost of decompressing the entire file multiple times.</p>
</li>
<li>
<p>Record Skew : A single bloated row/record could be the root cause for slow map task. The easiest way to identify this is by checking your string fields that has Json payload. ( Ex: A bug in a client could write a lot of data). You can identify the culprit by checking the max(size/length) of the field in your upstream table. For CL, <code>snapshot</code> is a candidate for bloated field.</p>
</li>
<li>
<p>Task Skew : **This is only applicable to the tables with non-splittable file format(like TEXT, zip) and parquet files should never run into this issue. Task skew is where one of the tasks got more rows than others and it is possible  if the upstream table has a single file that is large and has the non-splittable format.</p>
</li>
</ul></div>
</div>
</div>
<footer class="col-md-12">
<hr/>
<p>Copyright various authors 2022, CC-BY-SA 4.0</p>
<p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
</footer>
<script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
<script defer="" src="../../js/base.js"></script>
<script defer="" src="../../search/main.js"></script>
<div aria-hidden="true" aria-labelledby="searchModalLabel" class="modal" id="mkdocs_search_modal" role="dialog" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="searchModalLabel">Search</h4>
<button class="close" data-dismiss="modal" type="button"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
</div>
<div class="modal-body">
<p>From here you can search these documents. Enter your search terms below.</p>
<form>
<div class="form-group">
<input class="form-control" id="mkdocs-search-query" placeholder="Search..." title="Type search term here" type="search"/>
</div>
</form>
<div data-no-results-text="No results found" id="mkdocs-search-results"></div>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div><div aria-hidden="true" aria-labelledby="keyboardModalLabel" class="modal" id="mkdocs_keyboard_modal" role="dialog" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
<button class="close" data-dismiss="modal" type="button"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
</div>
<div class="modal-body">
<table class="table">
<thead>
<tr>
<th style="width: 20%;">Keys</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="help shortcut"><kbd>?</kbd></td>
<td>Open this help</td>
</tr>
<tr>
<td class="next shortcut"><kbd>n</kbd></td>
<td>Next page</td>
</tr>
<tr>
<td class="prev shortcut"><kbd>p</kbd></td>
<td>Previous page</td>
</tr>
<tr>
<td class="search shortcut"><kbd>s</kbd></td>
<td>Search</td>
</tr>
</tbody>
</table>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div>
<script src="https://unpkg.com/mermaid@8.8.0/dist/mermaid.min.js"></script><script>mermaid.initialize({
    securityLevel: "loose"
});</script></body>
</html>
